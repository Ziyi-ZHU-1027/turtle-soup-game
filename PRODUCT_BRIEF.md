# 海龟汤 — AI 情境猜谜游戏 · MVP 产品介绍

> 本文档面向后续协作的 AI / 设计师，旨在完整描述产品定位、核心玩法、前后端实现逻辑，以及当前的视觉与交互方案，以便进行视觉优化。

---

## 一、产品概述

### 1.1 什么是海龟汤？

"海龟汤"（Lateral Thinking Puzzle）是一种经典的情境推理游戏：
- **出题者**给出一个离奇的情境描述（称为"汤面"）
- **猜题者**只能通过"是/否"类型的提问来推理背后的完整故事（称为"汤底"）
- 直到猜题者还原出完整真相，游戏结束

### 1.2 我们的产品做了什么？

将传统的"出题者"角色交给 **AI**（DeepSeek 大模型），玩家通过**对话式交互**与 AI 进行问答博弈。AI 会根据预设的汤底判断玩家的每个提问，并给出"是 / 不是 / 接近答案 / 部分正确 / 无关 / 需要澄清"六种回复类型，同时在玩家卡住时主动给出提示。

### 1.3 核心卖点

| 卖点 | 说明 |
|------|------|
| **AI 实时对话** | 基于 DeepSeek 大模型，SSE 流式输出，打字机效果逐字呈现 |
| **智能提示系统** | 连续 5 次"不是"自动触发提示；10+ 问题后分析提问盲区 |
| **接近答案检测** | 当玩家提问与汤底关键词匹配度 ≥60% 时触发"接近答案"反馈 |
| **多难度谜题库** | 5 级难度（入门 → 地狱），支持标签分类 |
| **庆祝动效** | 猜中后触发彩带、烟花、庆祝文字等分级动画 |

---

## 二、用户角色与核心流程

### 2.1 用户角色

| 角色 | 权限 |
|------|------|
| **游客** | 可以浏览谜题、进行游戏（无需登录） |
| **注册用户** | 游戏 + 保存记录 |
| **管理员** | 谜题 CRUD、后台管理（通过邮箱白名单判定） |

### 2.2 核心游戏流程

```
┌─────────────┐     ┌──────────────┐     ┌────────────────┐
│  选择谜题    │ ──→ │  创建游戏会话  │ ──→ │  进入对话界面   │
│ (侧边栏列表) │     │ (POST /start) │     │ (ChatInterface) │
└─────────────┘     └──────────────┘     └────────┬───────┘
                                                   │
                    ┌──────────────────────────────┘
                    ▼
        ┌───────────────────────┐
        │   玩家输入提问         │ ←─────────────────┐
        │   (文本输入框)         │                    │
        └──────────┬────────────┘                    │
                   ▼                                 │
        ┌───────────────────────┐                    │
        │ 后端调用 DeepSeek API  │                    │
        │ SSE 流式返回           │                    │
        └──────────┬────────────┘                    │
                   ▼                                 │
        ┌───────────────────────┐     ┌──────────┐  │
        │ 解析回复类型           │ ──→ │ 是否猜中？│  │
        │ (是/不是/接近/部分/…)  │     └────┬─────┘  │
        └───────────────────────┘          │         │
                                     否    │  是     │
                                     ┌─────┴──┐     │
                                     ▼        ▼     │
                              继续提问 ──→ ───┘  🎉 庆祝动效
                              (检查是否          游戏结束
                               需要提示)
```

### 2.3 游戏结束方式

1. **猜中答案** → 触发庆祝动效 → 显示完整汤底
2. **查看答案**（主动揭晓） → 直接展示汤底
3. **放弃** → 标记为 abandoned → 可重新开始

---

## 三、页面结构与视觉方案

### 3.1 全局视觉风格

当前采用 **深色主题 (Dark Mode)**，整体氛围偏向神秘、悬疑：

| 元素 | 色值 | 用途 |
|------|------|------|
| 主背景 | `#0a0a1a` | 页面底色，深邃暗夜蓝 |
| 卡片/面板背景 | `#1a1a3e` / `rgba(26,26,62,0.9)` | 内容容器，半透明毛玻璃效果 |
| 主题金色 | `#c9a84c` | 按钮、高亮文字、图标、品牌色 |
| 次要紫灰 | `#9999bb` / `#2a2a5a` | 辅助文字、边框、次要信息 |
| 文本色 | `#e0e0e0` | 正文内容 |
| 错误红 | `#e74c3c` | 错误提示 |
| 成功绿 | `#27ae60` | 成功状态 |

**设计语言要点**：
- 使用 `backdrop-filter: blur()` 毛玻璃效果
- 渐变按钮（金色 → 深棕）
- 0.3s ease 过渡动画
- 圆角 12px~16px

### 3.2 页面详细拆解

---

#### 页面 1：首页 (HomeView)

**路由**：`/`

**布局结构**：
```
┌──────────────────────────────────────────────────┐
│                    Header                         │
│   Logo(🐢海龟汤)   首页  开始游戏  登录/注册      │
├──────────────────────────────────────────────────┤
│                                                   │
│              ✦ Hero Section ✦                     │
│                                                   │
│        "解开谜题，发现真相"                        │
│        副标题说明文字                              │
│        [开始游戏]  [了解更多]                      │
│                                                   │
├──────────────────────────────────────────────────┤
│                                                   │
│           ✦ Features Grid (2×2) ✦                │
│                                                   │
│   🤖 AI智能主持    📚 丰富题库                    │
│   💡 智能提示      🏆 成就系统(预留)              │
│                                                   │
├──────────────────────────────────────────────────┤
│                                                   │
│        ✦ How to Play (3步骤) ✦                   │
│                                                   │
│   ①选择谜题  →  ②提问推理  →  ③揭开真相          │
│                                                   │
├──────────────────────────────────────────────────┤
│                    Footer                         │
└──────────────────────────────────────────────────┘
```

**交互说明**：
- Hero 按钮点击跳转到 `/game`
- Features 卡片 hover 有上浮 + 阴影效果
- 步骤展示为带数字圆圈的横向流程

---

#### 页面 2：游戏主界面 (GameView + ChatInterface)

**路由**：`/game`

**这是产品的核心页面，布局如下**：

```
┌──────────────────────────────────────────────────────────┐
│                        Header                             │
├────────────┬─────────────────────────────────────────────┤
│            │                                              │
│  侧边栏     │            主内容区                         │
│  Sidebar   │                                              │
│  (280px)   │  ┌────────────────────────────────────────┐ │
│            │  │        汤面卡片 (可折叠)                 │ │
│ ┌────────┐ │  │  "一个男人走进餐厅点了一碗海龟汤…"      │ │
│ │ 谜题1  │ │  │  难度: ⭐⭐⭐   标签: [经典] [推理]     │ │
│ │ ⭐⭐   │ │  └────────────────────────────────────────┘ │
│ │ 经典   │ │                                              │
│ ├────────┤ │  ┌────────────────────────────────────────┐ │
│ │ 谜题2  │ │  │                                        │ │
│ │ ⭐⭐⭐ │ │  │          对话消息区                     │ │
│ │ 推理   │ │  │                                        │ │
│ ├────────┤ │  │  🤖 欢迎来到海龟汤！请开始提问…         │ │
│ │ 谜题3  │ │  │                                        │ │
│ │ ⭐     │ │  │  👤 这件事发生在白天吗？                │ │
│ │ 入门   │ │  │                                        │ │
│ └────────┘ │  │  🤖 不是，这件事不是发生在白天。        │ │
│            │  │                                        │ │
│ 游戏控制:   │  │  👤 是在室内吗？                       │ │
│ [揭晓答案] │  │                                        │ │
│ [放弃]     │  │  🤖 是的！事情发生在室内。 ✓            │ │
│ [重置]     │  │                                        │ │
│            │  │  💡 提示: 试试从人物动机角度思考...      │ │
│            │  │                                        │ │
│            │  └────────────────────────────────────────┘ │
│            │                                              │
│            │  ┌────────────────────────────────────────┐ │
│            │  │  [输入你的问题...]          [发送 ➤]    │ │
│            │  │                                        │ │
│            │  │  [💡提示] [❓已问N题] [👁揭晓] [🔄新局] │ │
│            │  └────────────────────────────────────────┘ │
├────────────┴─────────────────────────────────────────────┤
│                        Footer                             │
└──────────────────────────────────────────────────────────┘
```

**核心交互逻辑**：

1. **谜题选择**：
   - 侧边栏展示谜题列表，每个卡片显示标题、难度星级、标签
   - 点击谜题 → 创建游戏会话 → 主内容区切换到对话界面
   - 未选择谜题时显示空状态引导

2. **汤面卡片**：
   - 顶部固定展示当前谜题的情境描述（汤面）
   - 可点击折叠/展开，避免占用过多对话空间
   - 显示难度和标签信息

3. **对话消息区**：
   - **消息气泡**分三种角色样式：
     - 👤 用户消息：靠右对齐，金色背景
     - 🤖 AI 回复：靠左对齐，深色背景
     - ⚙️ 系统消息：居中，灰色
   - **流式输出**：AI 回复逐字显示，带闪烁光标动画
   - **时间戳**：相对时间（"刚刚"、"5分钟前"）
   - **Markdown 渲染**：AI 回复支持标题、列表、代码块、引用等
   - 新消息自动滚动到底部

4. **输入区域**：
   - 文本输入框 + 发送按钮
   - Enter 发送，Escape 清空
   - 发送中禁用输入（防止重复提交）
   - 流式响应期间显示加载状态

5. **底部工具栏**：
   - 💡 提示按钮：主动请求提示
   - ❓ 问题计数：显示已提问数量
   - 👁 揭晓答案：直接查看汤底（需确认）
   - 🔄 新游戏：重置当前会话

6. **提示消息**：
   - 连续 5 次"不是"后自动出现
   - 以系统消息样式显示
   - 包含分析出的提问盲区建议

7. **庆祝动效**（猜中时触发）：
   - 三个等级：light / medium / full
   - 彩纸粒子从顶部飘落
   - 烟花放射效果
   - 彩带飘动
   - 渐变庆祝文字
   - 自动 5 秒后消失

---

#### 页面 3：登录/注册 (LoginView)

**路由**：`/login`

```
┌────────────────────────────────────────┐
│              Header                     │
├────────────────────────────────────────┤
│                                        │
│        ┌────────────────────┐          │
│        │  [登录] | [注册]   │  ← Tab   │
│        │                    │          │
│        │  📧 邮箱           │          │
│        │  🔒 密码           │          │
│        │  ☐ 记住我          │          │
│        │                    │          │
│        │  [登 录]           │          │
│        │                    │          │
│        │  ── 或者 ──        │          │
│        │  [以游客身份继续]   │          │
│        └────────────────────┘          │
│                                        │
│   ┌──────────┐  ┌──────────┐          │
│   │ 为什么注册│  │ 数据安全  │          │
│   │ 的好处… │  │ 说明…    │          │
│   └──────────┘  └──────────┘          │
│                                        │
├────────────────────────────────────────┤
│              Footer                     │
└────────────────────────────────────────┘
```

**交互说明**：
- 登录/注册通过 Tab 切换，注册多一个"确认密码"和"昵称"字段
- 表单验证：密码最少 6 位、两次密码一致
- 游客模式直接跳转到游戏页

---

#### 页面 4：管理后台 (AdminView)

**路由**：`/admin`（仅管理员可见）

```
┌────────────────────────────────────────┐
│              Header                     │
├────────────────────────────────────────┤
│                                        │
│  [谜题管理] | [数据分析] | [用户管理]   │
│                                        │
│  ┌────────────────────────────────┐    │
│  │  [+ 添加新谜题]                │    │
│  │                                │    │
│  │  标题    难度  标签   操作      │    │
│  │  ────────────────────────────  │    │
│  │  谜题A   ⭐⭐  经典  [编辑|删除]│    │
│  │  谜题B   ⭐⭐⭐ 推理  [编辑|删除]│    │
│  │  谜题C   ⭐    入门  [编辑|删除]│    │
│  └────────────────────────────────┘    │
│                                        │
├────────────────────────────────────────┤
│              Footer                     │
└────────────────────────────────────────┘
```

**说明**：数据分析和用户管理 Tab 目前为"开发中"占位状态。

---

## 四、前端技术实现

### 4.1 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue 3 | 3.4.21 | 响应式 UI 框架 |
| Vite | 5.0.10 | 构建工具 |
| Pinia | 2.1.7 | 状态管理 |
| Vue Router | 4.2.5 | 路由管理 |
| Axios | 1.6.2 | HTTP 请求 |
| Supabase JS | 2.39.0 | 认证客户端 |
| markdown-it | 14.1.0 | Markdown 渲染 |

### 4.2 状态管理架构 (Pinia)

```
┌─────────────────────────────────────────────┐
│                 Pinia Stores                 │
├──────────┬───────────────┬──────────────────┤
│ authStore │  gameStore    │  puzzleStore     │
│          │               │                  │
│ · user   │ · session     │ · puzzles[]      │
│ · token  │ · messages[]  │ · currentPuzzle  │
│ · admin? │ · streaming   │ · pagination     │
│          │ · puzzle      │                  │
│ Actions: │ Actions:      │ Actions:         │
│ login()  │ startGame()   │ fetchPuzzles()   │
│ logout() │ sendMessage() │ createPuzzle()   │
│ register │ revealAnswer()│ updatePuzzle()   │
│          │ surrender()   │ deletePuzzle()   │
└──────────┴───────────────┴──────────────────┘
```

### 4.3 SSE 流式通信实现

前端通过 Fetch API 接收 Server-Sent Events：

```
前端 sendMessage()
    │
    ▼
fetch(POST /api/game/:id/chat, { stream: true })
    │
    ▼
reader = response.body.getReader()
    │
    ▼
循环读取 chunk ──→ 解析 SSE 格式
    │                  │
    │           event: chunk
    │           data: {"chunk":"是"}
    │                  │
    ▼                  ▼
gameStore.streamedResponse += chunk  ──→ UI 实时更新
    │
    ▼ (event: complete)
解析最终回复类型 → 更新 messages 数组
```

### 4.4 组件层级

```
App.vue
├── HomeView.vue
├── LoginView.vue
├── AdminView.vue
└── GameView.vue
    └── ChatInterface.vue
        ├── MessageBubble.vue (×N)
        └── CelebrationEffects.vue (条件渲染)
```

---

## 五、后端技术实现

### 5.1 技术栈

| 技术 | 用途 |
|------|------|
| Express.js 4.18 | Web 框架 |
| Supabase (PostgreSQL) | 数据库 + 认证 |
| DeepSeek API | AI 大模型 |
| Helmet | 安全头 |
| express-rate-limit | 限流（100次/15分钟） |

### 5.2 API 路由设计

```
/api
├── /health              GET    健康检查
├── /auth
│   ├── /me              GET    获取当前用户
│   └── /validate        POST   验证 Token
├── /puzzles
│   ├── /                GET    谜题列表（分页/筛选）
│   ├── /:id             GET    谜题详情（非管理员隐藏汤底）
│   ├── /                POST   创建谜题 [管理员]
│   ├── /:id             PUT    更新谜题 [管理员]
│   └── /:id             DELETE 删除谜题 [管理员]
└── /game
    ├── /start           POST   创建游戏会话
    ├── /session/:id     GET    获取会话信息
    ├── /:id/chat        POST   发送消息 (SSE 流式响应)
    ├── /:id/messages    GET    获取对话历史
    ├── /:id/reveal      POST   揭晓答案
    └── /:id/surrender   POST   放弃游戏
```

### 5.3 AI 服务核心逻辑

```
玩家提问
    │
    ▼
构建 System Prompt（包含汤面 + 汤底 + 回复规则）
    │
    ▼
附加对话历史（最近 20 轮）
    │
    ▼
调用 DeepSeek API（streaming 模式，temperature=0.1）
    │
    ▼
逐 chunk 通过 SSE 推送到前端
    │
    ▼
完整回复分析：
├── 回复类型判定（是/不是/接近/部分正确/无关/需澄清）
├── 连续"不是"计数 → ≥5 触发提示
├── 问题类型分析（人物/时间/地点/动机/方法/物品/情感/逻辑）
└── 接近度分析（关键词匹配 ≥60% → 接近，≥80% → 非常接近）
```

### 5.4 数据库结构

```
puzzles               game_sessions           conversations
┌──────────────┐     ┌───────────────────┐   ┌─────────────────┐
│ id (PK)      │     │ id (PK)           │   │ id (PK)         │
│ title        │◄────│ puzzle_id (FK)     │   │ session_id (FK) │──►game_sessions
│ description  │     │ user_id (FK?)      │   │ role            │
│ solution     │     │ status             │   │ content         │
│ difficulty   │     │ consecutive_no_cnt │   │ metadata        │
│ tags[]       │     │ start_time         │   │ created_at      │
│ created_by   │     │ end_time           │   └─────────────────┘
│ created_at   │     │ updated_at         │
└──────────────┘     └───────────────────┘
```

---

## 六、部署架构

```
┌─────────────┐     ┌─────────────────────────────┐
│   浏览器     │────→│         Vercel               │
│             │     │                               │
│  Vue SPA    │     │  ┌───────────┐  ┌──────────┐ │
│             │     │  │ CDN       │  │ Serverless│ │
│             │◄────│  │ (静态资源) │  │ Functions │ │
│             │     │  │ /index.html│ │ /api/*    │ │
│             │     │  └───────────┘  └────┬─────┘ │
└─────────────┘     └──────────────────────┼───────┘
                                           │
                           ┌───────────────┼───────────────┐
                           ▼                               ▼
                    ┌──────────────┐              ┌──────────────┐
                    │   Supabase   │              │  DeepSeek API │
                    │ (PostgreSQL  │              │  (AI 大模型)   │
                    │  + Auth)     │              │               │
                    └──────────────┘              └──────────────┘
```

---

## 七、当前视觉问题与优化方向建议

以下是 MVP 当前视觉层面的现状概述，供后续视觉优化参考：

### 7.1 当前实现方式
- **纯 CSS 实现**：没有使用 UI 组件库，所有样式手写
- **内联样式为主**：大量样式写在 Vue 单文件组件的 `<style scoped>` 中
- **全局样式**：`main.css` 定义了基础变量和通用样式
- **无设计系统**：没有统一的 Design Token / 组件规范

### 7.2 现有视觉特点
- 深色主题，神秘悬疑氛围
- 金色作为品牌色 / 强调色
- 毛玻璃效果用于卡片容器
- 渐变按钮
- 有基础的 hover / transition 动效
- 庆祝动效使用纯 CSS + JS 动画实现（彩纸、烟花、彩带）

### 7.3 可能的优化方向
1. **视觉一致性**：统一间距、圆角、阴影、字体层级
2. **消息气泡**：当前样式较基础，可优化回复类型的视觉区分（"是"用绿色高亮、"不是"用红色、"接近"用金色脉冲等）
3. **汤面卡片**：可以增加氛围感（纸张质感、暗纹、印章效果等）
4. **侧边栏谜题列表**：难度和标签的视觉表达可更精致
5. **流式输出动效**：打字机光标和加载状态可更精细
6. **移动端适配**：当前有基础响应式（768px 断点），但体验可进一步优化
7. **空状态 & 引导**：未选谜题时的空状态页面可增加插画引导
8. **微交互**：按钮点击反馈、消息发送动画、状态切换过渡等

### 7.4 关键交互节点（需重点设计）
1. **首次进入游戏页** → 引导选择谜题
2. **发送问题等待 AI** → 流式加载状态
3. **收到"接近答案"** → 激励反馈
4. **连续被否定** → 提示出现的方式
5. **猜中答案** → 庆祝动效 + 汤底揭晓
6. **查看/放弃** → 确认对话框 + 结果展示

---

## 八、文件索引

| 模块 | 关键文件路径 |
|------|-------------|
| 前端入口 | `frontend/src/main.js` |
| 根组件 | `frontend/src/App.vue` |
| 路由 | `frontend/src/router/index.js` |
| 首页 | `frontend/src/views/HomeView.vue` |
| 游戏页 | `frontend/src/views/GameView.vue` |
| 登录页 | `frontend/src/views/LoginView.vue` |
| 管理页 | `frontend/src/views/AdminView.vue` |
| 对话组件 | `frontend/src/components/Game/ChatInterface.vue` |
| 消息气泡 | `frontend/src/components/Game/MessageBubble.vue` |
| 庆祝动效 | `frontend/src/components/Effects/CelebrationEffects.vue` |
| 游戏状态 | `frontend/src/stores/game.js` |
| 认证状态 | `frontend/src/stores/auth.js` |
| API 客户端 | `frontend/src/services/api.js` |
| 全局样式 | `frontend/src/assets/main.css` |
| 后端入口 | `backend/src/index.js` |
| 游戏路由 | `backend/src/routes/game.js` |
| AI 服务 | `backend/src/services/aiService.js` |
| 数据库服务 | `backend/src/services/supabaseService.js` |
| 部署配置 | `vercel.json` |
