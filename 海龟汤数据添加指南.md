# 海龟汤数据库数据添加指南

## 概述

本指南旨在帮助您向海龟汤游戏数据库中添加新的谜题数据。当前项目使用 Supabase PostgreSQL 数据库，已有完整的 `puzzles` 表结构和3个示例谜题。

## 快速开始

### 方法一：通过API添加（推荐）

如果您是技术人员，建议使用API方式添加数据：

```bash
# 1. 获取管理员JWT令牌（通过Supabase Auth）
curl -X POST "https://YOUR_PROJECT.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: YOUR_SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "your-password"}'

# 2. 保存返回的access_token作为YOUR_JWT_TOKEN

# 3. 添加新谜题
curl -X POST "https://your-app.vercel.app/api/puzzles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "title": "消失的乘客",
    "description": "一辆公交车上有5名乘客，第一站下去2人，上来3人；第二站下去1人，上来4人。问：公交车司机叫什么名字？",
    "solution": "公交车司机叫'你'，因为题目开头说'一辆公交车上有5名乘客'，司机不算乘客。",
    "difficulty": 1,
    "tags": ["脑筋急转弯", "趣味"]
  }'
```

### 方法二：通过管理界面添加（需先完善）

访问前端应用的 `/admin` 页面，但当前添加功能显示"开发中..."。如需使用此方式，需要先完善 [AdminView.vue](frontend/src/views/AdminView.vue) 文件。

## 详细指南

### 数据格式要求

每个谜题必须包含以下字段：

```json
{
  "title": "谜题标题（必填，字符串）",
  "description": "汤面描述（必填，字符串）",
  "solution": "汤底答案（必填，字符串）",
  "difficulty": "难度等级（可选，整数1-5，默认3）",
  "tags": "标签分类（可选，字符串数组，如['经典', '职业']）"
}
```

### 难度等级说明
- **1**：非常简单（适合新手）
- **2**：简单
- **3**：中等（默认）
- **4**：困难
- **5**：非常困难（挑战性）

### 标签建议
使用有意义的标签便于分类搜索：
- `经典`、`黑暗`、`心理`、`职业`、`医疗`、`谜语`、`脑筋急转弯`、`趣味`、`逻辑`、`日常`

## 四种添加方式详解

### 1. API调用方式（最灵活）

**适用场景**：技术人员、批量导入、自动化脚本

#### 完整步骤：

1. **环境准备**
   ```bash
   # 检查后端服务是否运行
   curl -I http://localhost:3001/api/puzzles

   # 检查环境变量配置
   cat backend/.env | grep ADMIN_EMAILS
   ```

2. **获取认证令牌**
   ```bash
   # 方式A：通过Supabase Auth（生产环境）
   curl -X POST "https://YOUR_PROJECT.supabase.co/auth/v1/token?grant_type=password" \
     -H "apikey: YOUR_SUPABASE_ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{"email": "admin@example.com", "password": "your-password"}'

   # 方式B：通过本地登录（开发环境）
   curl -X POST http://localhost:3001/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "admin@example.com"}'
   ```

3. **添加谜题**
   ```bash
   # 单个谜题添加
   curl -X POST http://localhost:3001/api/puzzles \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -d '{
       "title": "电梯里的男人",
       "description": "一个男人每天上班都要坐电梯到10楼，但下班时只坐到7楼就走楼梯。为什么？",
       "solution": "男人是个侏儒，上班时按10楼按钮可以够到，下班时7楼以上的按钮都够不到，只能从7楼走楼梯下去。",
       "difficulty": 3,
       "tags": ["经典", "职场"]
     }'

   # 批量添加脚本示例
   # 创建 import-puzzles.sh
   ```

4. **验证添加成功**
   ```bash
   # 查看所有谜题
   curl http://localhost:3001/api/puzzles

   # 查看最新添加的谜题
   curl "http://localhost:3001/api/puzzles?page=1&limit=5"
   ```

#### Node.js批量导入脚本

创建 `import-puzzles.js`：

```javascript
const axios = require('axios');

const puzzles = [
  {
    title: "深夜的电话",
    description: "一个男人深夜接到一个电话，对方什么都没说就挂了。男人随即拿起刀出了门。为什么？",
    solution: "男人是一名外科医生，深夜的电话是医院的紧急呼叫。他没有说话是因为他喉咙痛失声了。他拿刀是因为手术刀放在医疗包里，他准备去做紧急手术。",
    difficulty: 3,
    tags: ["经典", "职业", "医疗"]
  },
  {
    title: "雨中的男人",
    description: "一个男人在雨中行走，没有打伞，但身上一点都没湿。为什么？",
    solution: "男人是个雕像，被放置在广场上。下雨时雕像当然不会湿，因为它没有生命。",
    difficulty: 2,
    tags: ["经典", "谜语"]
  },
  // 添加更多谜题...
];

async function importPuzzles() {
  const token = "YOUR_ADMIN_JWT_TOKEN";
  const baseURL = "http://localhost:3001/api";

  console.log(`开始导入 ${puzzles.length} 个谜题...`);

  let successCount = 0;
  let failCount = 0;

  for (const puzzle of puzzles) {
    try {
      const response = await axios.post(`${baseURL}/puzzles`, puzzle, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log(`✓ 成功: ${puzzle.title}`);
      successCount++;

      // 避免过快请求
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`✗ 失败: ${puzzle.title}`, error.response?.data || error.message);
      failCount++;
    }
  }

  console.log(`\n导入完成！成功: ${successCount}, 失败: ${failCount}`);
}

importPuzzles();
```

运行脚本：
```bash
cd backend
node import-puzzles.js
```

### 2. 管理界面方式（最用户友好）

**适用场景**：非技术人员、日常少量添加

#### 当前状态：
管理界面位于 [AdminView.vue](frontend/src/views/AdminView.vue)，但添加功能显示"开发中..."。

#### 需要完善的功能：
1. **表单界面**：替换第84行的`<p>开发中...</p>`为完整表单
2. **表单字段**：title, description, solution, difficulty, tags
3. **API集成**：调用puzzles store的创建action
4. **表单验证**：必填字段验证、难度范围检查

#### 快速完善方案：
修改 `frontend/src/views/AdminView.vue` 第84-86行：

```vue
<div class="modal-body">
  <form @submit.prevent="handleSubmit" class="add-puzzle-form">
    <div class="form-group">
      <label for="title">谜题标题 *</label>
      <input
        id="title"
        v-model="newPuzzle.title"
        type="text"
        required
        placeholder="例如：深夜的电话"
      >
    </div>

    <div class="form-group">
      <label for="description">汤面描述 *</label>
      <textarea
        id="description"
        v-model="newPuzzle.description"
        required
        rows="4"
        placeholder="详细描述情境..."
      ></textarea>
    </div>

    <div class="form-group">
      <label for="solution">汤底答案 *</label>
      <textarea
        id="solution"
        v-model="newPuzzle.solution"
        required
        rows="4"
        placeholder="完整的谜底解释..."
      ></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="difficulty">难度等级</label>
        <select id="difficulty" v-model="newPuzzle.difficulty">
          <option value="1">⭐ 非常简单</option>
          <option value="2">⭐⭐ 简单</option>
          <option value="3" selected>⭐⭐⭐ 中等</option>
          <option value="4">⭐⭐⭐⭐ 困难</option>
          <option value="5">⭐⭐⭐⭐⭐ 非常困难</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tags">标签（逗号分隔）</label>
        <input
          id="tags"
          v-model="tagsInput"
          type="text"
          placeholder="经典,职业,医疗"
        >
        <small>用逗号分隔多个标签</small>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" @click="showAddForm = false">取消</button>
      <button type="submit" class="btn-primary">添加谜题</button>
    </div>
  </form>
</div>
```

同时需要更新script部分处理表单提交。

### 3. Supabase Dashboard方式（最直接）

**适用场景**：紧急修复、数据检查、简单操作

#### 操作步骤：
1. 访问 [Supabase Dashboard](https://app.supabase.com)
2. 选择您的项目
3. 左侧菜单选择 **Table Editor**
4. 选择 `puzzles` 表
5. 点击 **Insert row** 按钮

#### 字段填写指南：
- **id**: 留空（自动生成UUID）
- **title**: 谜题标题（字符串）
- **description**: 汤面描述（字符串）
- **solution**: 汤底答案（字符串）
- **difficulty**: 难度等级（1-5整数）
- **tags**: 点击 `{}` 图标，输入数组格式：`{"经典","职业","医疗"}`
- **created_at**: 留空（自动生成当前时间）
- **updated_at**: 留空（自动更新）
- **created_by**: 可选，关联用户ID

#### 注意事项：
- tags字段必须是PostgreSQL数组格式
- 避免在生产环境频繁直接操作
- 添加后建议通过API验证数据

### 4. SQL脚本方式（最适合批量）

**适用场景**：大量数据迁移、初始化数据、版本控制

#### 创建SQL脚本：
保存为 `add_puzzles.sql`：

```sql
-- 海龟汤谜题批量导入脚本
-- 文件：add_puzzles.sql
-- 说明：批量插入新谜题到puzzles表

INSERT INTO puzzles (title, description, solution, difficulty, tags) VALUES
(
  '电梯里的男人',
  '一个男人每天上班都要坐电梯到10楼，但下班时只坐到7楼就走楼梯。为什么？',
  '男人是个侏儒，上班时按10楼按钮可以够到，下班时7楼以上的按钮都够不到，只能从7楼走楼梯下去。',
  3,
  ARRAY['经典', '职场']
),
(
  '房间里的灯',
  '一个房间里有三盏灯，房间外有三个开关分别控制这三盏灯。你只能进入房间一次，如何确定哪个开关控制哪盏灯？',
  '先打开第一个开关，等5分钟后关闭。然后打开第二个开关，立即进入房间。摸一下灯泡：热的但没亮的是第一个开关，亮的是第二个开关，凉的是第三个开关。',
  4,
  ARRAY['逻辑', '脑筋急转弯']
),
(
  '沙漠中的瓶子',
  '一个人在沙漠中发现一个瓶子，他打开瓶子后突然变得非常富有。为什么？',
  '瓶子里装的是藏宝图，根据藏宝图他找到了宝藏。',
  2,
  ARRAY['冒险', '财富']
),
(
  '无声的对话',
  '两个聋哑人在餐厅里，服务员过来后，其中一人突然大叫一声。为什么？',
  '他的同伴突发疾病，他无法说话，只能通过大叫引起服务员注意。',
  3,
  ARRAY['医疗', '日常']
),
(
  '书店的谜题',
  '一个人走进书店，买了一套百科全书的第一卷，但拒绝购买其他卷。为什么？',
  '他只需要第一卷的封面来参加化装舞会，扮演"百科全书推销员"。',
  4,
  ARRAY['幽默', '职业']
);

-- 验证插入结果
SELECT
  COUNT(*) as 总数,
  AVG(difficulty) as 平均难度,
  array_to_string(array_agg(DISTINCT unnest(tags)), ', ') as 所有标签
FROM puzzles;
```

#### 执行SQL脚本：
- **Supabase Dashboard**：进入 SQL Editor，粘贴并执行
- **命令行**：
  ```bash
  psql "postgresql://postgres:YOUR_PASSWORD@db.supabase.co:5432/postgres" -f add_puzzles.sql
  ```

#### 验证数据：
```sql
-- 查看最新添加的谜题
SELECT title, difficulty, tags, created_at
FROM puzzles
ORDER BY created_at DESC
LIMIT 10;

-- 按难度统计
SELECT difficulty, COUNT(*) as 数量
FROM puzzles
GROUP BY difficulty
ORDER BY difficulty;
```

## 数据验证和测试

### 1. API验证
```bash
# 查看所有谜题
curl http://localhost:3001/api/puzzles

# 查看特定谜题（普通用户看不到solution）
curl http://localhost:3001/api/puzzles/谜题ID

# 管理员查看（包含solution）
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:3001/api/puzzles/谜题ID
```

### 2. 游戏流程测试
1. 启动前端应用
2. 选择新添加的谜题开始游戏
3. 测试提问功能是否正常
4. 验证AI回答逻辑是否正确
5. 测试查看汤底功能

### 3. 前端显示测试
1. 检查谜题列表是否显示新数据
2. 验证难度星级显示是否正确
3. 检查标签过滤功能是否正常
4. 测试搜索功能能否找到新谜题

## 故障排除

### 常见问题及解决方案：

#### 1. API返回401/403错误
**问题**：没有权限添加谜题
**解决**：
```bash
# 检查管理员邮箱配置
cat backend/.env | grep ADMIN_EMAILS

# 验证邮箱是否正确
ADMIN_EMAILS=your-email@example.com

# 重启后端服务
cd backend && npm run dev
```

#### 2. 数据格式错误
**问题**：API返回400错误
**解决**：
```bash
# 检查JSON格式
echo '{
  "title": "测试",
  "description": "描述",
  "solution": "答案"
}' | jq .

# 验证字段是否完整
# 必须包含：title, description, solution
```

#### 3. 数据库连接失败
**问题**：无法连接到Supabase
**解决**：
```bash
# 检查环境变量
cat backend/.env | grep SUPABASE

# 验证Supabase项目状态
# 访问：https://app.supabase.com/project/YOUR_PROJECT
```

#### 4. 前端不显示新数据
**问题**：添加成功但前端不显示
**解决**：
```bash
# 清除浏览器缓存
# 或使用隐私模式访问

# 检查API响应
curl http://localhost:3001/api/puzzles | jq '.data[0]'

# 查看前端网络请求
# 浏览器开发者工具 -> Network
```

## 最佳实践

### 数据质量
1. **汤面描述**：清晰、完整、无歧义
2. **汤底答案**：逻辑严密、合理、有趣
3. **难度分级**：准确反映谜题复杂度
4. **标签分类**：一致、有意义、便于搜索

### 安全注意事项
1. **管理员验证**：妥善保管`ADMIN_EMAILS`配置
2. **API保护**：生产环境启用HTTPS和速率限制
3. **数据备份**：定期备份数据库
4. **环境隔离**：开发/测试/生产环境分离

### 批量操作建议
1. **分批处理**：大量数据分批次导入
2. **错误处理**：添加重试机制和详细日志
3. **进度跟踪**：显示导入进度和统计信息
4. **数据验证**：导入前后验证数据一致性

## 示例谜题库

### 经典谜题示例：
```json
[
  {
    "title": "深夜的电话",
    "description": "一个男人深夜接到一个电话，对方什么都没说就挂了。男人随即拿起刀出了门。为什么？",
    "solution": "男人是一名外科医生，深夜的电话是医院的紧急呼叫。他没有说话是因为他喉咙痛失声了。他拿刀是因为手术刀放在医疗包里，他准备去做紧急手术。",
    "difficulty": 3,
    "tags": ["经典", "职业", "医疗"]
  },
  {
    "title": "雨中的男人",
    "description": "一个男人在雨中行走，没有打伞，但身上一点都没湿。为什么？",
    "solution": "男人是个雕像，被放置在广场上。下雨时雕像当然不会湿，因为它没有生命。",
    "difficulty": 2,
    "tags": ["经典", "谜语"]
  },
  {
    "title": "葬礼上的陌生人",
    "description": "在一场葬礼上，一个女人见到了一个从未见过的英俊男人。她对他一见钟情。几天后，她杀死了自己的姐姐。为什么？",
    "solution": "女人相信那个英俊男人会再次出现在她姐姐的葬礼上，想再见他一面。",
    "difficulty": 4,
    "tags": ["黑暗", "心理", "经典"]
  }
]
```

### 新谜题创意：
1. **职场类**：办公室、会议室、工作场景
2. **日常类**：家庭、学校、公共场所
3. **奇幻类**：超自然、科幻、神话元素
4. **逻辑类**：推理、解谜、数学问题
5. **幽默类**：搞笑、荒诞、反转结局

## 获取帮助

### 项目文件参考：
- [puzzles.js](backend/src/routes/puzzles.js) - API路由实现
- [AdminView.vue](frontend/src/views/AdminView.vue) - 管理界面
- [001_initial_schema.sql](supabase/migrations/001_initial_schema.sql) - 数据库结构
- [README.md](README.md) - 项目文档

### 需要进一步帮助？
如果您需要：
1. 完善管理界面
2. 创建批量导入脚本
3. 调试API问题
4. 设计谜题内容

请提供具体需求，我会协助您完成。

---

*最后更新：2026年2月21日*
*祝您添加数据顺利，游戏更加丰富多彩！*