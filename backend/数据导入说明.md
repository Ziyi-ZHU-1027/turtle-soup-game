# 海龟汤谜题数据导入工具

## 快速开始

### 1. 安装依赖
确保已安装 Node.js (>=18.0.0) 和项目依赖：
```bash
cd backend
npm install
```

### 2. 获取管理员令牌
您需要管理员JWT令牌来添加谜题：

**方法A：通过Supabase Auth（生产环境）**
```bash
curl -X POST "https://YOUR_PROJECT.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: YOUR_SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "your-password"}'
```

**方法B：通过本地API（开发环境）**
1. 确保后端服务运行：`npm run dev`
2. 使用管理员邮箱登录前端应用
3. 从浏览器开发者工具获取Authorization头中的Bearer令牌

### 3. 运行导入脚本

**使用示例数据：**
```bash
# 1. 编辑 import-puzzles.js，设置您的令牌
# 修改 CONFIG.ADMIN_TOKEN = '您的令牌'

# 2. 运行导入
node import-puzzles.js
```

**使用自定义数据文件：**
```bash
# 1. 准备JSON文件（参考 sample-puzzles.json）
# 2. 运行导入
node import-puzzles.js --file your-puzzles.json --token YOUR_TOKEN
```

**使用命令行参数：**
```bash
# 指定所有参数
node import-puzzles.js \
  --file puzzles.json \
  --token eyJhbGciOiJ... \
  --url http://localhost:3001
```

### 4. 验证导入结果
脚本会自动验证导入结果。您也可以手动验证：
```bash
# 查看所有谜题
curl http://localhost:3001/api/puzzles

# 查看最新添加的
curl "http://localhost:3001/api/puzzles?page=1&limit=5"
```

## 文件说明

### 主要脚本
- **import-puzzles.js** - 主导入脚本，支持批量导入、错误重试、进度显示
- **sample-puzzles.json** - 示例谜题数据文件（10个经典谜题）
- **数据导入说明.md** - 本说明文件

### 配置文件
脚本中的配置区域（可以修改）：
```javascript
const CONFIG = {
  API_BASE_URL: 'http://localhost:3001',  // API地址
  ADMIN_TOKEN: 'YOUR_TOKEN_HERE',         // 管理员令牌
  REQUEST_DELAY: 500,                     // 请求间隔（毫秒）
  LOG_LEVEL: 'verbose',                   // 日志级别
  MAX_RETRIES: 3,                         // 最大重试次数
};
```

### 数据格式
每个谜题需要以下字段：
```json
{
  "title": "谜题标题（必填）",
  "description": "汤面描述（必填）",
  "solution": "汤底答案（必填）",
  "difficulty": "难度1-5（可选，默认3）",
  "tags": ["标签数组", "可选"]
}
```

## 高级用法

### 环境变量配置
```bash
# 设置环境变量
export ADMIN_TOKEN="your-jwt-token"
export API_BASE_URL="http://localhost:3001"

# 运行脚本（会自动使用环境变量）
node import-puzzles.js --file puzzles.json
```

### 自定义数据文件
创建自己的数据文件 `my-puzzles.json`：
```json
[
  {
    "title": "您的谜题标题",
    "description": "汤面描述...",
    "solution": "汤底答案...",
    "difficulty": 3,
    "tags": ["经典", "自定义标签"]
  }
]
```

运行：
```bash
node import-puzzles.js --file my-puzzles.json
```

### 从JavaScript文件导入
创建 `my-puzzles.js`：
```javascript
// 可以动态生成数据
module.exports = [
  {
    title: "动态生成的谜题",
    description: `描述内容 ${new Date().getFullYear()}`,
    solution: "答案内容",
    difficulty: Math.floor(Math.random() * 5) + 1,
    tags: ["动态", "测试"]
  }
];
```

运行：
```bash
node import-puzzles.js --file my-puzzles.js
```

## 故障排除

### 常见问题

**1. "未设置管理员令牌"错误**
```bash
# 解决方案：
# 1. 设置环境变量
export ADMIN_TOKEN="your-token"

# 2. 或使用--token参数
node import-puzzles.js --token your-token

# 3. 或修改脚本中的CONFIG.ADMIN_TOKEN
```

**2. "API连接失败"错误**
```bash
# 检查后端服务是否运行
curl -I http://localhost:3001/api/puzzles

# 如果未运行，启动后端
cd backend && npm run dev

# 检查API_BASE_URL配置
```

**3. "认证失败"错误**
```bash
# 令牌可能已过期，获取新令牌
# 检查管理员邮箱是否正确配置在backend/.env中
ADMIN_EMAILS=your-email@example.com
```

**4. "数据验证失败"错误**
```bash
# 检查数据格式
# 确保title、description、solution字段都存在且为非空字符串
# difficulty必须是1-5的整数
# tags必须是字符串数组
```

### 调试模式
启用详细日志：
```javascript
// 在import-puzzles.js中修改
const CONFIG = {
  LOG_LEVEL: 'verbose',  // 改为'verbose'查看详细日志
  // ...
};
```

或运行：
```bash
node import-puzzles.js --file puzzles.json 2>&1 | tee import.log
```

## 批量导入最佳实践

### 1. 分批次导入
对于大量数据（>100条），建议分批导入：
```bash
# 创建多个小文件
split -l 50 large-puzzles.json puzzles-part-

# 分批导入
for file in puzzles-part-*; do
  echo "导入 $file..."
  node import-puzzles.js --file "$file" --token YOUR_TOKEN
  sleep 2  # 批次间暂停
done
```

### 2. 监控导入进度
脚本会显示实时进度。您也可以查看生成的日志文件：
```bash
# 保存详细日志
node import-puzzles.js --file puzzles.json 2>&1 | tee import-$(date +%Y%m%d-%H%M%S).log
```

### 3. 验证导入结果
导入后验证数据完整性：
```bash
# 统计总数
curl -s http://localhost:3001/api/puzzles | jq '.pagination.total'

# 查看最新添加的
curl -s "http://localhost:3001/api/puzzles?limit=5" | jq '.data[] | .title'
```

## 安全注意事项

1. **保护令牌**：不要将令牌提交到版本控制
2. **环境分离**：开发、测试、生产环境使用不同的令牌
3. **权限控制**：确保只有管理员可以添加谜题
4. **数据验证**：所有输入数据都应验证格式和内容
5. **错误处理**：脚本包含错误处理和重试机制

## 扩展开发

### 修改脚本行为
您可以修改 `import-puzzles.js` 中的以下函数：

1. **validatePuzzle()** - 自定义数据验证规则
2. **retryRequest()** - 调整重试逻辑
3. **CONFIG对象** - 修改默认配置

### 集成到CI/CD
可以将导入脚本集成到部署流程中：
```yaml
# GitHub Actions 示例
name: Import Puzzles
on:
  push:
    paths:
      - 'puzzles/**'
jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Import puzzles
        run: |
          cd backend
          node import-puzzles.js --file ../puzzles/latest.json \
            --token ${{ secrets.ADMIN_TOKEN }} \
            --url ${{ secrets.API_URL }}
```

## 获取帮助

如有问题，请参考：

1. **项目文档**：[../README.md](../README.md)
2. **API文档**：运行后端后访问 `http://localhost:3001/api-docs`（如果配置了）
3. **Supabase文档**：https://supabase.com/docs
4. **脚本源码**：查看 `import-puzzles.js` 中的注释和代码

## 更新日志

- **v1.0.0** (2026-02-21)
  - 初始版本发布
  - 支持JSON和JS数据文件
  - 包含错误重试和进度显示
  - 提供10个示例谜题

---

*祝您导入顺利！如有问题或建议，请随时反馈。*